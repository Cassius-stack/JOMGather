{% extends "base.html" %}

{% block title %}Upload Your Story - Slice of Life{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="mb-4">
        <a href="{{ url_for('slice_of_life.prompt') }}" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left me-1"></i>Back to Prompt
        </a>
    </div>

    <div class="row">
        <!-- Left Column - Prompt & Upload -->
        <div class="col-lg-6 mb-4">
            <!-- Today's Prompt -->
            <div class="card border-0 shadow-sm mb-4"
                style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <div class="card-body p-4 text-white">
                    <p class="text-uppercase small opacity-75 mb-2">
                        <i class="bi bi-calendar-event me-1"></i>Today's Prompt
                    </p>
                    <h4 style="line-height: 1.4;">
                        "What is your favourite thing to do after school/work?"
                    </h4>
                </div>
            </div>

            <!-- Image Upload Area -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-image text-primary me-2"></i>Upload Your Photo
                    </h5>
                    <p class="text-muted mb-4">
                        Share a photo that represents your answer to the prompt. It could be a place, an activity, or
                        anything meaningful to you!
                    </p>

                    <!-- Upload Zone -->
                    <div class="upload-zone text-center p-5 mb-3"
                        style="border: 2px dashed #dee2e6; border-radius: 15px; background: #f8f9fa; cursor: pointer;"
                        onclick="document.getElementById('imageUpload').click()">
                        <div id="uploadPreview" style="display: none;">
                            <img id="previewImage" src="" alt="Preview" class="img-fluid rounded mb-3"
                                style="max-height: 300px;">
                            <p class="text-success mb-0"><i class="bi bi-check-circle me-1"></i>Image selected</p>
                        </div>
                        <div id="uploadPlaceholder">
                            <i class="bi bi-cloud-arrow-up text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3 mb-1">Click to upload or drag and drop</p>
                            <small class="text-muted">PNG, JPG up to 10MB</small>
                        </div>
                        <input type="file" id="imageUpload" name="image" accept="image/*" class="d-none"
                            onchange="previewUpload(this)">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                            onclick="document.getElementById('imageUpload').click()">
                            <i class="bi bi-folder me-1"></i>Choose File
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-camera me-1"></i>Take Photo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Story Form -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-pen text-primary me-2"></i>Share Your Thoughts
                    </h5>
                    <p class="text-muted mb-4">
                        What does your photo mean to you? Share the story behind it.
                    </p>

                    <form method="POST" action="{{ url_for('slice_of_life.create_display') }}"
                        enctype="multipart/form-data">
                        <!-- User Indicator -->
                        <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <span>You're responding as a <strong>Youth</strong>. Your partner <strong>Grandma
                                    Rose</strong> will also respond.</span>
                        </div>

                        <!-- Story Input -->
                        <div class="mb-4">
                            <label for="story" class="form-label fw-bold">Your Story</label>
                            <textarea class="form-control" id="story" name="story" rows="8" placeholder="Tell the story behind your photo...

What made you choose this image?
What memory or feeling does it capture?
How does it relate to the prompt?

Be as personal as you'd like - your partner will share their perspective too!" required maxlength="2000"></textarea>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">Write from the heart!</small>
                                <small class="text-muted"><span id="charCount">0</span>/2000</small>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn" disabled>
                            <i class="bi bi-send me-2"></i>Submit My Response
                        </button>

                        <p class="text-center text-muted small mt-3 mb-0">
                            <i class="bi bi-lock me-1"></i>Your response stays private until both partners submit
                        </p>
                    </form>
                </div>
            </div>

            <!-- What Happens Next -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-arrow-right-circle text-primary me-2"></i>What Happens
                        Next?</h6>
                    <ol class="mb-0 text-muted">
                        <li class="mb-2">Your partner will receive the same prompt</li>
                        <li class="mb-2">Once both of you submit, you'll enter <strong>Review Mode</strong></li>
                        <li class="mb-2">Comment on each other's submissions</li>
                        <li>Decide together to publish (public or private)</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Character counter
    const storyTextarea = document.getElementById('story');
    const charCount = document.getElementById('charCount');
    const submitBtn = document.getElementById('submitBtn');
    let imageSelected = false;

    storyTextarea.addEventListener('input', function () {
        charCount.textContent = this.value.length;
        checkFormValidity();
    });

    function previewUpload(input) {
        const preview = document.getElementById('uploadPreview');
        const placeholder = document.getElementById('uploadPlaceholder');
        const previewImage = document.getElementById('previewImage');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                imageSelected = true;
                checkFormValidity();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function checkFormValidity() {
        const hasStory = storyTextarea.value.trim().length > 10;
        submitBtn.disabled = !(imageSelected && hasStory);
    }
</script>
{% endblock %}